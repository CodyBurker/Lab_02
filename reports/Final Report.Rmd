---
title: "Can implementing state policies help prevent the state-wide spread of COVID-19?"
author: 'Cody Burker, Emily Fernandes, Margo Suryanaga'
output: 
   bookdown::pdf_document2:
    extra_dependencies: ["float"]
header-includes:
   \usepackage{float}
   \floatplacement{figure}{H}
---

```{r setup&getdata, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library("data.table")
library("ggplot2")
library("lubridate")
library("dplyr")
library("zoo")
library(naniar)
library(patchwork)
library(sandwich)
library(lmtest)
library(nortest)
library(HH)
library(lattice)
library(stargazer)
```

\newpage

# Introduction

The Covid-19 pandemic is the first pandemic seen in a century, affecting each individual worldwide. While many countries issued lockdowns, travel quarantines, and other Covid-19 restrictions on a federal level, the US federal government placed the power with the governors to regulate the implementation of these restrictions on a state-by-state basis.

There has been increased skepticism on the true effectiveness of restrictions in slowing down the spread of Covid-19, especially due to the amount of economic impact resulting from these procedures. Evaluating which Covid-19 restrictions helped prevent the initial spread of Covid-19 within that state helps citizens understand the importance of following these policies. Understanding the effectiveness of Covid-19 restrictions in slowing the initial spread of the disease also helps policy makers justify the implementation of these policies to their constituents. Additionally, this information might be of interest to public health officials who are looking for best practices to contain a future pandemic or infectious disease.

From this, we are focusing on the following main research question: `Which Covid-19 policies implemented by states have an effect on the statewide initial spread of Covid-19?`

As part of our research we will specifically be looking at the following policies implemented by various states: 1. Stay at home/shelter in place order length 2. Face mask mandate specifically for businesses length 3. Interstate travel quarantine length 4. Restaurant shutdown length 5. Gyms shutdown length 6. Bars shutdown length 7. Declaration of a state of emergency

Understanding the nature of Covid-19 as being a highly infectious disease, we believe the first few months are the most crucial times in controlling an outbreak. Thus, we define an `initial spread of Covid-19` to be the number of cases at 05/31/2020. We believe this reflects the initial rise of cases from $0$ to $x$ within the first few crucial months of the pandemic.

We used the following data sources: 

a) [Covid-19 US State Policy Database](www.tinyurl.com/statepolicies) A database of state policy responses to the pandemic, compiled by researchers at the Boston University School of Public Health.

We used this data source to get start and end dates to evaluate length in days of policies 1 through 6 listed above and the date a state of emergency was declared to evaluate the speed at which a state of emergency was declared within each state (policy 7). This source additionally provided us with population data by state and population density per square mile by state.

b)  [NY Times Covid-19 Data Repository](https://github.com/nytimes/covid-19-data) A series of data files with cumulative counts of coronavirus cases in the United States, at the state and county level, over time.

We used this data source to get the number of cases at 05/31/2020 on a state level.

```{r Initial data cleaning, include=FALSE}
# Initial data capture and cleansing
calc_num_days <- function(str,end,end.date) {
   str[str=="NA"] = end.date
   end[end=="NA"] = end.date
   
   
   end.date = as.Date(end.date)
   str=as.Date(str)
   
   end=as.Date(end)
   end[end> end.date] = end.date

   ind = end-str
   
   ind[ind <= 0] = 0  
   ind = as.numeric(ind)
   
   df <- data.frame (STR  = str,END = end, DIFF = ind)
   
  return(ind)
}
calc_num_days_n <- function(str,end,end.date) {
   str[str=="NA"] = end.date
   end[end=="NA"] = end.date
   
   
   end.date = as.Date(end.date)
   str=as.Date(str)
   
   end=as.Date(end)
   end[end> end.date] = end.date

   ind = end-str
   ind = as.numeric(ind)
   df <- data.frame (STR  = str,END = end, DIFF = ind)
   print(df)
   
  return(ind)
}

#Collect NYT's Covid-19 Data
NYT_Data <- fread("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")
NYT_Data

str.date = "2020-01-20"
end.date = "2020-05-31"

ref.date.list = seq(as.Date(str.date), as.Date(end.date), by="days")

#Treat Dates as Dates
NYT_Data[,date:=as.Date(date)]
NYT_Data <- NYT_Data[NYT_Data$date==end.date,]


#Collect CUSP Policy Data
CUSP_Data=read.csv("CUSP_Clean.csv",na.strings = c(0))
CUSP_Data$state = CUSP_Data$State

#Merge Data
total_data = merge(NYT_Data, CUSP_Data, by = "state")
total_data<-total_data[order(total_data$state,total_data$date), ]

date = ref.date.list
##Create Stay Home Variables 
str1.stay.home.date = total_data$Stay.at.home.shelter.in.place
str2.stay.home.date = total_data$Stay.at.home.order.issued.but.did.not.specifically.restrict.movement.of.the.general.public
str.stay.home.date <- ifelse(str1.stay.home.date=='NA', str2.stay.home.date, str1.stay.home.date)
end.stay.home.date = total_data$End.stay.at.home.shelter.in.place

total_data$stay.home.total=calc_num_days(str.stay.home.date,end.stay.home.date,end.date)

##Create Face Mask and Travel Variables 
str.maskB.date = total_data$Business.face.mask.mandate
str.travel.date.all = total_data$Quarantine.mandate.for.all.travelers
str.travel.date.some = total_data$Quarantine.mandate.for.some.travelers
str.travel.date <- ifelse(str.travel.date.all=='NA', str.travel.date.some, str.travel.date.all)

end.maskB.date = total_data$End.face.mask.mandate
end.travel.date = total_data$Quarantine.mandate.ended

total_data$maskB.total=calc_num_days(str.maskB.date,end.maskB.date,end.date)
total_data$travel.total=calc_num_days(str.travel.date,end.travel.date,end.date)

#Round 1 Shutdowns
str.res1.date = total_data$Closed.restaurants
end.res1.date = total_data$Reopened.restaurants

str.gym1.date = total_data$Closed.gyms
end.gym1.date = total_data$Reopened.gyms

str.bar1.date = total_data$Closed.bars
end.bar1.date = total_data$Reopened.bars   

total_data$res1.total=calc_num_days(str.res1.date,end.res1.date,end.date)
total_data$gym1.total=calc_num_days(str.gym1.date,end.gym1.date,end.date)
total_data$bar1.total=calc_num_days(str.bar1.date,end.bar1.date,end.date)

#Include Population Data
total_data$population = as.numeric(total_data$Population.2018)
total_data$population.density = as.numeric(total_data$Population.density.per.square.mile)
total_data$cases = as.numeric(total_data$cases)
   
#Create Speed Variables
pandemic_date = rep('2020-03-11', length(str.stay.home.date))  
state.of.emergency = total_data$State.of.emergency
state.of.emergency.speed = calc_num_days_n(state.of.emergency, pandemic_date,end.date)
```

# Model Building

To best answer our research question, we created a series of models to explain the relationship between the various state policies put in place to curtail the spread of the virus and the number of cases observed in each state. Throughout our analysis we will address the 7 policies we list in `Introduction` as the following independent variables:

1. Business mask mandate (measured in days the policy was in place) 
2. Stay at home/shelter in place order (measured in days the policy was in place) 
3. Interstate travel quarantines (measured in days the policy was in place) 
4. Restaurant Shutdowns (measured in days the policy was in place) 
5. Bar Shutdowns (measured in days the policy was in place) 
6. Gym Shutdowns (measured in days the policy was in place) 
7. State of Emergency declared in relationship to 3-11-2020 (Date that the World Health Organization declared the Covid-19 Pandemic) 

The spread of Covid-19 is not just influenced by state policies, but also through person-to-person contact within each state. In an effort to capture this, we will also include the population density as an independent variable. With these variables, we hope to explain which state policies were effective at curtailing the initial spread of the Covid-19 virus.

```{r vartransformations,include=FALSE}
# Variable Transformations
Model_Data=total_data
Model_Data$case.per.100k = (Model_Data$cases/Model_Data$population)*100000
Model_Data$case.log = log(Model_Data$case.per.100k)
Model_Data$population.density.log = log(Model_Data$population.density)
```

## Model 1

First, we began to explore the number of cases in each state per 100,000 residents, which is our dependent variable. This allowed us to account for the number of cases while accounting for the population of each state. For example, we expect New York and California to have a much larger number of cases than Alaska simply due to these states having many more residents. After viewing the histogram of the number of cases per state per 100,000 residents, our team chose to reduce the skew of the data by applying a log transformation to this variable. The histogram of the log transformed variable can be seen in Figure \@ref(fig:casesvslog).

```{r casesvslog, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Log Transform of Dependent Variable", fig.height=3}
require(gridExtra)
hist1<-ggplot(Model_Data, aes(x=case.per.100k)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab('Cases/100k Residents')+
   # ggtitle('Predicted Variable Histograms')+
  theme(plot.title = element_text(hjust = 0.5))
hist2<-ggplot(Model_Data, aes(x=case.log)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab('Log transform of Cases/ 100k Residents')
grid.arrange(hist1, hist2, nrow=1) 
```

```{r densitytransform, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.cap="Log Transform of Population Density", fig.pos="!H"}
hist1<-ggplot(Model_Data, aes(x=population.density)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("State Population Density (People/sq mile) ")+
   # ggtitle('Input Variable Histograms')+
  theme(plot.title = element_text(hjust = 0.5)) + 
   theme(axis.text.x=element_text(hjust=0.95,vjust=0.2))
hist2<-ggplot(Model_Data, aes(x=population.density.log)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Log of State's Population Density")
grid.arrange(hist1, hist2, nrow=1)
```

For our base model, we selected the one independent variable that was a characteristic of the state and not a policy enacted by the state. We believe a state's population density can be used to represent the largest transmitter of Covid-19, direct person-to-person contact. Therefore, we hypothesize the state's population density is the first building block in describing the number of Covid-19 cases on 05/31/2020. Again, after viewing the initial highly skewed histogram we chose to perform a log transformation on this variable. The transformed histogram can be seen in Figure \@ref(fig:densitytransform).

Our base model looks at the relationship of the natural log of each state's cases on 05/31/2020 per 100,000 residents with the natural log of state's population density.

```{r BaseModel,include=FALSE}
#Base Model
model1 = lm(case.log~population.density.log, data = Model_Data)
```

## Model 2

For our next model, we added three independent variables representing key state policies to our base model. This medium complexity model will account for the number of days each state had a:

-   Stay at home/shelter in place order
-   Interstate travel quarantine
-   Business mask mandate

The stay at home order was the first and strongest policy set by many states. This was a drastic policy enacted to limit direct contact between people in the hopes that it would slow the spread of Covid-19. We expect a strong relationship between lengthier stay at home orders and curtailed spread. The interstate travel quarantine was another attempt to limit direct contact with visitors from other states (especially those who may have been subject to less restrictive policies). Our final additional independent variable describes the length of each state's face mask mandate for businesses in order to capture the safety measures taken as states attempted to reopen their economies.

The histograms of our three new input variables show distributions which are in line with our expectations, as can be seen in Figure \@ref(fig:model2variables). We did notice a spike within all three distributions at zero but we attribute this to states that did not wish to implement this specific policy. Hence our team did not opt to implement any type of variable transformation.

```{r model2variables, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Model 2 Independent Variables", fig.height=4}
#Input Histograms 
input_1<-ggplot(Model_Data, aes(x=population.density.log)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Log of State's Population Density")
input_2<-ggplot(Model_Data, aes(x=maskB.total)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab('Business Mask Mandate (Days in Place)')
input_3<-ggplot(Model_Data, aes(x=stay.home.total)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab(paste('Stay at Home/Shelter in Place Order','\n','(Days in Place)'))
input_4<-ggplot(Model_Data, aes(x=travel.total)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab('Interstate Travel Quarantine (Days in Place)')
grid.arrange(input_1,input_2,input_3,input_4, nrow=2) 
```

```{r MediumModel,include=FALSE}
#Medium Model
model2 = lm(case.log~population.density.log+
                      maskB.total+ 
                      stay.home.total+
                      travel.total, data = Model_Data)
```

## Model 3

And finally for our most complex model, we additionally account for the number of days each state had:

-   Restaurant Shutdowns
-   Bar Shutdowns
-   Gym Shutdowns

We have also included a variable to account for the speed each state declared a State of Emergency. This variable is the number of days between the declared State of Emergency and the day the World Health Organization (WHO) declared Covid-19 a pandemic (3/11/2020).

In our final model we included data that further supported the policies covered in our medium complexity model. For example, the shutting down of restaurants, bars, and gyms made it much easier for the public to comply with the stay at home mandate. After all, if all the public spaces within the state are closed, where will people congregate? Unfortunately, this may also lead to multicolinearity between the variables, adding noise to our model if shutdowns occurred simultaneously or if shutdowns occurred at the same time as the stay at home order. We expect a relationship between longer shutdowns and lower infection rates.

We also added an independent variable to capture how quickly a state responded to this crisis. Preemptive policies will lead to fewer initial cases and therefore fewer initial vectors to spread the disease. This variable represents the number of days between when a state declared a state of emergency and the day the WHO declared Covid-19 a pandemic. It is noteworthy that the variable describing the speed of State of Emergency Declaration may be negative. This means that the state in question declared a State of Emergency before the WHO officially declared Covid-19 a pandemic. We expect a negative or small number of days (States of Emergency called before or around 3/11/2020) will align with lower infection rates.

We reviewed the histograms of our new input variables, as seen in Figure \@ref(fig:model3hists). The speed of each state's State of Emergency declaration closely aligns to a normal distribution. However each of the shutdown variables displays a slight skew. While not ideal, this skew does not span over factors of tens and therefore we did not feel it appropriate to use a log transformation.

```{r model3hists, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Histograms for Additional Variables in Model 3", fig.height=3}
#Input Hist 
input_1<-ggplot(Model_Data, aes(x=res1.total)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Restaurant Shutdowns (Days)")
input_2<-ggplot(Model_Data, aes(x=bar1.total)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Bar Shutdowns (Days)")
input_3<-ggplot(Model_Data, aes(x=gym1.total)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Gym Shutdowns (Days)")
input_4<-ggplot(Model_Data, aes(x=state.of.emergency.speed)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab('Speed of State of Emergency (Days)')
grid.arrange(input_1,input_2,input_3,input_4, nrow=2) 
```

```{r ComplexModel,include=FALSE}
#Complex Model
model3 = lm(case.log~population.density.log+
                      maskB.total+
                      stay.home.total+
                      travel.total+
                      res1.total+
                      bar1.total+
                      gym1.total+ 
                      state.of.emergency.speed, data = Model_Data)
```

# Regression Table

Table \@ref(tab:regression) displays the regression of all 3 models. We used robust standard error in our calculations. What follows is an analysis of the results of our models.

\newpage

```{r regression, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
# Assumes that the following models are in-memory:
# model1
# model2
# model3

# Adjust standard errors
cov1 <- vcovHC(model1)
rse1 <- sqrt(diag(cov1))
cov2 <- vcovHC(model2)
rse2 <- sqrt(diag(cov2))
cov3 <- vcovHC(model3)
rse3 <- sqrt(diag(cov3))

p_val1 <- coeftest(model1, vcov. = cov1)[,4]
p_val2 <- coeftest(model2, vcov. = cov2)[,4]
p_val3 <- coeftest(model3, vcov. = cov3)[,4]

# Get new f statistics
f_stat1 <- waldtest(model1, vcov = cov1)
f_stat2 <- waldtest(model2, vcov = cov2)
f_stat3 <- waldtest(model3, vcov = cov3)

# Create string array of modified F statistic
f_stat_string = c("F-Statistic",
                        paste(round(f_stat1$F[2],3),"***"," (df = 1; 49)", sep=""),
                        paste(round(f_stat1$F[2],3),"***"," (df = 5; 45)", sep=""),
                        paste(round(f_stat3$F[2],3),"***"," (df = 9; 41)", sep="")
           )

stargazer(model1, model2, model3, type="latex",
          title = "Regression Table",
          covariate.labels = c("Log (Population Density)",
                               "Business mask mandate (days)",
                               "Stay at home/shelter in place order (days)",
                               "Interstate Travel Quarantine (days)",
                               "Restaurant Shutdown Length (days)",
                               "Bar Shutdown Length (days)",
                               "Gym Shutdown Length (days)",
                               "State of Emergency Speed (days)"
          ),
          dep.var.labels = c(""),
          dep.var.caption = "Dependent Variable: Log (Covid-19 Cases)",
          column.labels = c("Simple Model","Moderate Model","Complex Model"),
          se = list(rse1, rse2, rse3),
          omit.stat = "f",
          add.lines = list(f_stat_string),
          header=FALSE,
          label = "tab:regression",
          p = list(p_val1, p_val2, p_val3)
)
```

## Model 1

We will begin by inspecting the first Model in Table \@ref(tab:regression). Here we see a significant relationship between Log (Population Density) and Log (Covid-19 Cases). Figure \@ref(fig:covid-density-scatter) displays a scatterplot of the two, and we do see some relationship exists. The coefficient is positive, indicating that a greater population density is related to a larger number of Covid-19 cases per 100,000 people within a state. Because (using robust standard errors) this relationship is significant (p \< 0.001) we reject the hypothesis that there is no relationship between Log (Population Density) and Log(Covid-19 Cases) in favor of the hypothesis that there is a relationship. The following model was used to test the relationship between the two variables:

$$
\log (\text{Covid-19 Cases}) = \beta_0 + \beta_1 \log (\text{Population Density}) \\
$$

This model implies that every percent increase in Population Density (measured in people / square mile) causes a `r model1$coefficients[2] %>% format(digits=2)`% increase in Covid-19 Cases per 100,000 people in a state. This translates to have great practical significance when we look at a state-by-state comparison. While it is likely not feasible to reduce Population Density, this number might inform policy makers as to which states are more vulnerable to future pandemics. Furthermore, this model has an $R^2$ value of `r format(summary(model1)$r.squared, digits=2)`, indicating that the transformed population density may account for a surprising amount of the variance in Log (Covid-19 Cases).

```{r covid-density-scatter, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Scatterplot of Model 1", fig.height=3}
ggplot(Model_Data, aes(y=case.log, x=population.density.log)) + 
  geom_point() + 
  geom_smooth(method="lm", se = FALSE) + 
  labs(title = "Model 1: Log Population Density vs Log Covid-19 Cases",
       x = "Log Population Density" , y = "Log Covid-19 Cases")
```

## Model 2

For our second model, we find evidence that there is a relationship between our dependent variable and how long the business face mask mandate was in place (Business mask Mandate), how long the stay at home order was in place (Stay at home/shelter in place order), and how long the interstate travel quarantine was in place (Interstate Travel Quarantine In Place Length) in addition to variable Log (Population Density). The coefficient for Log (Population Density) decreases slightly from 0.358 to 0.329 but remains significant, indicating that some of its explanatory power is shared between the other variables we have included (and also perhaps there is a small amount of colinearity between this variable and one or more of the others).

When we inspect the Stay at home/shelter in place order coefficient, we see that it is both significant and negative. This indicates that for every extra day that a state has a Stay at home/shelter in place order in effect (if all else is held equal), we expect to see a `r round(model2$coefficients['stay.home.total'] * -1 *  100,3)`% *decrease* in Covid-19 cases. This is a very large number, and because it has a small p-value we are sure that a relationship exists. This speaks strongly to the efficacy of such orders, and the low p-value of `r round(coeftest(model2, vcov=cov2)[4,4],3)` gives us reason to believe that there is a relatively low probability this relationship exists by chance.

Inspection of the Interstate Travel Quarantine In Place Length leads to a similar result. We see that the p-value is low enough (`r round(coeftest(model2, vcov=cov2)[5,4],3)`) that we should reject the idea that restricting travel does not affect Covid-19 cases. The effect size (1 more day of restricting interstate travel leads to `r round(model2$coefficients['travel.total'] * -100,3)`% decrease in Covid-19 cases, all else held equal) is nearly as large as the Stay at home/shelter in place order, meaning that they have relatively similar effects on Covid-19 cases.

When we inspect the Business mask mandate variable, we find something surprising: it is significant, however it is also positive. This is counterintuitive: we would expect that the longer a mandate for business masks is in place, the lower the number of cases. One explanation for this might be reverse causality. Although we assumed that Business mask mandate influenced Log (Covid-19 Cases), it is possible that Log (Covid-19 Cases) also influenced Business mask mandate. For example, as the number of Covid-19 cases increased, states instituted or extended their business mask mandates as a result/in reaction to rising cases. This would explain why, according to our model, every 1 days of increased business mask mandate is associated with a `r round(model2$coefficients['maskB.total'] * 100,3)`% increase in Covid-19 cases per 100,000 residents. As will be further explained within the `Omitted Variables` section, we believe this may also be attributed to an omitted variable bias.

A one-way analysis of variance (ANOVA) test reveals that the addition of these three variables to the base model results in a statistically significant benefit.

## Model 3

For our last model, we added an additional four extra variables. However, we found that none of the additional variables were statistically significant and that the Adjusted $R^2$ actually decreased (from 0.550 to 0.525) compared to the second model, indicating that this model is not efficient. We also see some interesting effects on the variables that were already in model 2. Stay at home/shelter in place order and Interstate Travel Quarantine In Place Length actually are no longer significant. This might indicate that there exists one or more colinear relationships between these two variables and the new variables added. Business mask mandate remains significant and Log (Population Density) retains its significance (alluding to a very strong relationship). Overall this model does not seem to provide much useful information compared to the previous, simpler models.

A one-way analysis of variance (ANOVA) test reveals that the addition of these four variables to the medium complexity model does not result in a statistically significant benefit.

# Limitations

For each model we will evaluate the assumptions for a Classical Liner Model. These requirements are:

1.  Independent and identically distributed data
2.  Linear Conditional Expectation Exists
3.  No Colinearity
4.  No Homoskedastic Error
5.  Normal Residuals

## Independent and identically distributed data

The data used in our models represents the number of Covid-19 cases and state level policy decisions for all 50 states of the United States along with the District of Columbia. We can assume the data sampled from each state/district is identically distributed and independent from one another.

We do acknowledge some concern may exist as to the true independence of each state in that the Covid-19 cases in one state may effect an adjacent state. Additionally the policies of one state, a collection of states, or the federal government may have an influencing effect of a state's policy. This lack of independence may explain the skew to the shutdown data. Large populated states such as California and New York began to shut businesses down early and many other smaller states followed suit shortly afterwards. That being said, the sampling of one state does not directly affect the sample of another state. Therefor, we conclude that the data used in this analysis is independent and identically distributed.

## Linear Conditional Expectation Exists

To evaluate if the relationship between our input and output variables is indeed linear, we plotted the predicted values against their residuals.

```{r residualsplot, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Independent Variable vs Residuals for Models 1,2,3"}
Model_Data <- Model_Data %>%  mutate(model1_res = resid(model1))
Model_Data <- Model_Data %>% mutate(model1_prd = predict(model1)) 

#Residuals versus Predictors
Residuals_Plot1 = ggplot(data = Model_Data, aes(x = model1_prd, y = model1_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Base Model Residuals')+xlab('Predicted Values')


Model_Data <- Model_Data %>%  mutate(model2_res = resid(model2))
Model_Data <- Model_Data %>% mutate(model2_prd = predict(model2)) 

#Residuals versus Predictors
Residuals_Plot2 = ggplot(data = Model_Data, aes(x = model2_prd, y = model2_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Medium Model Residuals')+xlab('Predicted Values')


Model_Data <- Model_Data %>%  mutate(model3_res = resid(model3))
Model_Data <- Model_Data %>% mutate(model3_prd = predict(model3)) 

#Residuals versus Predictors
Residuals_Plot3 = ggplot(data = Model_Data, aes(x = model3_prd, y = model3_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Complex Model Residuals')+xlab('Predicted Values')


grid.arrange(Residuals_Plot1,Residuals_Plot2,Residuals_Plot3,nrow=2) 
```

From the Residual/Predictors plot shown in Figure \@ref(fig:residualsplot), one can see that this basic model's predictors has a fairly linear relationship with residuals implying that a Linear Conditional Expectation exists for all models.

## Perfect Collinearity

Our base model cannot possibly have perfect colinearity because it only has one input variable. We evaluated multicollinearity using variance inflation factors for our medium complexity model and complex model. Our medium complexity model's variance inflation factors are particularly small (less than 2) and imply that there is no concern for multicollinearity. However our complex model's variance inflation factors are quite large (several of the Shut Down variables are between 5-9). This implies that there may be multicollinearity. This judgment is subjective. If after reviewing the model coefficients we believe that this potential multicollinearity creates confusion in the model, the solution would be to limit our input variables to one variable to that we believe is representative of all the shut down inputs (for example, the model could include only the restaurant shutdowns instead of restaurant, bar, and gym shutdowns).

## Homoskedastic Error

To evaluate the presence of heteroskedastic errors, we will plot the residuals in relationship to the model's independent variables. For our base model, we will plot the base model residuals versus the log transformation of each state's population density. This is shown in Figure \@ref(fig:homoskedastic).

```{r homoskedastic, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.cap="Homoskedastic Error of Model 2"}
Homoskedastic_Plot = ggplot(data = Model_Data, aes(x = population.density.log, y = model2_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Residuals')+xlab("Log(Population Density)")
Homoskedastic_Plot
```

The Residual/Input plot displays a flaring of the standard error at the extremes which implies the potential for heteroskedastic errors.

For our medium complexity model, we will plot the residuals in relationship to the model's four dependent variables. We will plot the base model residuals versus:

-   the log transformation of each state's population density
-   Business mask mandate (days in place)
-   Stay at home/shelter in place order (days in place)
-   Interstate travel quarantine (days in place)

```{r hokmoskedasticmedium, echo=FALSE, fig.cap="Homoskedastic Plots for Medium Complex Model", fig.height=3, message=FALSE, warning=FALSE}
Homoskedastic_Plot1 = ggplot(data = Model_Data, aes(x = population.density.log, y = model2_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Residuals')+xlab('Log (Population Density)')
Homoskedastic_Plot2 = ggplot(data = Model_Data, aes(x = maskB.total, y = model2_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Residuals')+xlab("Business mask mandate")
Homoskedastic_Plot3 = ggplot(data = Model_Data, aes(x = stay.home.total, y = model2_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Residuals')+xlab("Stay at home/shelter in place order")
Homoskedastic_Plot4 = ggplot(data = Model_Data, aes(x = travel.total, y = model2_res)) + 
  geom_point() + stat_smooth(se = TRUE)+
  ylab('Residuals')+xlab('Interstate Travel Quarantine ')
grid.arrange(Homoskedastic_Plot1,Homoskedastic_Plot2,Homoskedastic_Plot3,Homoskedastic_Plot4,nrow=2) 
```

The Residual/Input plot for the log of the population density still displays a flaring of the standard error of the residuals at the extremes, as shown in Figure \@ref(fig:hokmoskedasticmedium). The business mask mandate and interstate travel quarantine also display inconsistent standard errors. These factors suggest the potential for heteroskedastic errors. To mitigate this, we will use robust standard error when reviewing the significance level of medium complexity model's coefficients.

The log transformation of each state's population density also affects the complex model (suggesting heteroskedastic error), therefore we will use robust standard error when reviewing the significance level of all model's coefficients.

## Normal Residuals

Lastly we have a histogram of each model's residuals to ensure they are normal. As you can see from the Figure \@ref(fig:residshist), the residuals are in fact normally distributed for all models.

```{r residshist, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Distribution of Residuals of All 3 Models", fig.height=3}
#Histogram of Residuals
Normal_Residuals1<-ggplot(Model_Data, aes(x=model1_res)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Base Model Residuals")
#Histogram of Residuals
Normal_Residuals2<-ggplot(Model_Data, aes(x=model2_res)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Medium Complexity")
#Histogram of Residuals
Normal_Residuals3<-ggplot(Model_Data, aes(x=model3_res)) + 
   geom_histogram(color="black", fill="grey")+
   ylab('Frequency')+xlab("Complex Model Residuals")

 grid.arrange(Normal_Residuals1,Normal_Residuals2,Normal_Residuals3,nrow=1) 
```

## Other Remarks

Finally it is important to note that our analysis has collapsed this time series data to merely look at one point in time. We have attempted to include variables that are measured in length of days in order to account for the importance of time on this analysis, but this does not counteract the fact that this analysis would be improved by looking at the timing of these policies being implemented.

Additionally, our variables capture the length of time a mandate was in place, but not necessarily how effectively the mandate was enforced. For example, it is possible a state implemented an interstate travel quarantine but did not have the required infrastructure to enforce it. This means that we may not be capturing the effects of an interstate travel quarantine, but instead the effect of a state declaring an interstate travel quarantine.

# Discussion of Omitted Variables

## Omitted variable 1: Number of tourists

The first omitted variable we consider is number of tourists. Through background knowledge, our expectation is that the greater the number of tourists the quicker the spread of Covid-19. States with a greater number of tourists may also be more inclined to have a interstate travel quarantine in place for a longer period of time in order to help contain the spread of Covid-19. While we believe this variable may have an impact on our model, we did not have access to it as part of the two data sources mentioned in our `Introduction` section and thus have omitted it.

We believe there would be a positive correlation between the number of tourists and our variable `Interstate Travel Quarantine in Place Length`. As mentioned above, we believe the greater the number of tourists a state has the longer it would have an interstate travel quarantine in place. Additionally, we believe the number of tourists would have a positive effect on the model output as a larger number of tourists increases the likelihood of a quicker spread of COVID-19. Since the coefficient for our variable `Interstate Travel Quarantine in Place Length` is negative, we believe the direction of the bias is towards zero.

### Omitted variable 2: Number of essential businesses

The second omitted variable we consider are the number of essential businesses within a state. Essential businesses are exempt from statewide stay at home or shelter in place orders and can opt to still have their employees come into offices. Therefore, we believe states with a greater number of essential businesses have a greater potential of a lengthier business face mask mandate. Additionally, due to the fact that there would be a greater number of people who would be unable to stay at home, we expect everyone else who can would be expected to stay at home for a longer period of time. We did not have access to this data as part of the two data sources mentioned in our `Introduction` section and thus have omitted it from our model.

We believe there would be a positive correlation between the number of essential businesses and our variable `Business mask mandates` due to our previous reasoning. Additionally, we believe the number of essential businesses would have a positive effect on the model output as a larger number of essential businesses mean a larger number of the population who cannot stay at or work from home. Since the coefficient of our variable `Business mask mandates` is positive, we believe the direction of the bias is away from zero.

We believe there would also be a positive correlation between the number of essential businesses and our variable `Stay at home/shelter in place order` due to our reasoning above. As mentioned earlier, we also believe that the number of essential businesses would have a positive effect on the model output. Therefore, since the coefficient of our variable `Stay at home/shelter in place order` is negative, we believe the direction of the bias is towards zero.

## Omitted variable 3: Amount of public sanitation stations

Another omitted variable of interest is the amount of public sanitation stations that exist within a state. One of the recommended ways to prevent the spread of COVID-19 is through sanitizing which could be greatly improved through a greater amount of public sanitation stations. We would additionally expect there to be a greater number of public sanitation stations with a more densely populated state.

We believe there would be a positive correlation between the amount of public sanitation stations and our variable `Log(Population Density)` due to our reasoning above. Additionally, we believe the amount of public sanitation stations would have a negative effect on the model output as we believe increased sanitation decreases the rate at which COVID-19 spreads. Therefore, since the coefficient of variable `Log(Population Density)` is positive, we believe the direction of the bias is towards zero.

## Omitted variable 4: Days with cold or freezing temperatures

Our fourth omitted variable we consider are the number of days with cold or freezing temperatures. We believe this omitted variable may have an effect on the bias of the stay at home length. From prior knowledge, we believe that people are more likely to obey the stay at home order on days with cold or freezing temperatures and are more likely to leave their homes on days with warm temperatures. Therefore, we would expect state officials to be more likely to implement or extend stay at home or shelter in place orders should they expect cold or freezing days (for example, a blizzard on a day).

We believe there would be a positive correlation between the number of days with cold or freezing temperatures and our `Stay at home/shelter in place order` variable due to the reasoning mentioned above. Additionally, days with cold or freezing temperatures would force more people to stay indoors and therefore we believe this omitted variable would have a positive effect on the model itself. Since the coefficient of our `Stay at home/shelter in place order` variable is negative, we believe the direction of our bias is towards zero.

## Omitted variable 5: Number of schools shut down

The final omitted variable we consider are the number of schools shut down. From prior knowledge we know that some schools partially shut down, some completely shut down and went virtual, and some went on a hybrid model where students came in for a partial week. Therefore, though we recognize that we could retrieve the number of schools within a state we chose to omit this variable due to us not being able to confirm the true number of schools fully shut down.

We believe there would be a positive correlation between the number of schools shut down to our variable `Log(Population Density)`. Additionally, we believe this omitted variable would have a negative coefficient within our model. Therefore, we believe the direction of the bias is towards zero.

# Conclusion

Our research has confirmed our suspicion that population density has an effect on Covid-19 spread ($R^2=0.39$). Furthermore, we were able to detect a relationship between key actions taken at the state-level, and Covid-19 spread. We found that Stay at home/shelter in place orders and Interstate Travel Quarantines both led to lower Covid-19 rates (`r round(model2$coefficients['stay.home.total'] *   100,3)`% per day and `r round(model2$coefficients['travel.total'] *   100,3)`% per day, respectively). However we found that longer Business Mask Mandates were associated with *higher* Covid-19 rates (`r round(model2$coefficients['maskB.total'] *  100,3)`% increase in cases per 100k people per day). This could mean that longer mask mandates led to higher Covid-19 rates, but it could also be due to reverse-causality bias (states put longer policies in place as a response to higher Covid-19 rates). Moreover, we reason that due to an omitted variable (*Number of essential businesses*) the Business Mask Mandates is likely biased away from zero. Overall, we found interesting results that demonstrate the effect that public health policy had on the transmission of Covid-19.
